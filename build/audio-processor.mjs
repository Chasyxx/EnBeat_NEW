class t extends AudioWorkletProcessor{constructor(...e){super(...e),this.audioSample=0,this.byteSample=0,this.drawMode="Points",this.errorDisplayed=!0,this.func=null,this.getValues=null,this.isFuncbeat=!1,this.isPlaying=!1,this.playbackSpeed=1,this.divisorStorage=0,this.lastTime=-1,this.lastFuncValue=[0,0],this.lastByteValue=[0,0],this.outValue=[0,0],this.sampleRate=8e3,this.sampleRatio=1,this.sampleDivisor=1,this.soundMode="Bytebeat",Object.seal(this),t.deleteGlobals(),t.freezeGlobals(),this.port.addEventListener("message",(t=>this.receiveData(t.data))),this.port.start()}static deleteGlobals(){for(let t=0;t<26;++t)delete globalThis[String.fromCharCode(65+t)],delete globalThis[String.fromCharCode(97+t)];for(const t in globalThis)Object.prototype.hasOwnProperty.call(globalThis,t)&&delete globalThis[t]}static freezeGlobals(){Object.getOwnPropertyNames(globalThis).forEach((t=>{const e=globalThis[t],s=typeof e;"object"!==s&&"function"!==s||"globalThis"===t||Object.freeze(e),"function"===s&&Object.prototype.hasOwnProperty.call(e,"prototype")&&Object.freeze(e.prototype),Object.defineProperty(globalThis,t,{writable:!1,configurable:!1})}))}static getErrorMessage(t,e){const s=null===e?"compilation":"t="+e;if(!(t instanceof Error))return`${s} thrown: ${"string"==typeof t?t:JSON.stringify(t)}`;const{message:a,lineNumber:i,columnNumber:l}=t;return`${s} error${"number"==typeof i&&"number"==typeof l?` (at line ${i-3}, character ${+l})`:""}: ${"string"==typeof a?a:JSON.stringify(a)}`}process(e,[s]){const a=s[0].length;if(!a||!this.isPlaying)return!0;let i=this.sampleRatio*this.audioSample;this.sampleDivisor;let{byteSample:l}=this;const r=[],o="Combined"===this.drawMode||"Diagram"===this.drawMode;for(let e=0;e<a;++e){i+=this.sampleRatio;const a=Math.floor(i);if(this.lastTime!==a){let e;const s=Math.floor(l);try{e=this.isFuncbeat?this.func(s/this.sampleRate,this.sampleRate):this.func(s)}catch(a){this.errorDisplayed&&(this.errorDisplayed=!1,this.sendData({error:{message:t.getErrorMessage(a,s),isRuntime:!0}})),e=NaN}e=Array.isArray(e)?[e[0],e[1]]:[e,e];let i=!1,h=2;for(;h--;){try{e[h]=+e[h]}catch(t){e[h]=NaN}o?(isNaN(e[h])?this.lastByteValue[h]=NaN:this.outValue[h]=this.getValues(e[h],h),i=!0):e[h]!==this.lastFuncValue[h]&&(isNaN(e[h])?isNaN(this.lastFuncValue[h])||(this.lastByteValue[h]=NaN,i=!0):(this.outValue[h]=this.getValues(e[h],h),i=!0))}i&&r.push({t:s,value:[...this.lastByteValue]}),l+=a-this.lastTime,this.lastFuncValue=e,this.lastTime=a}s[0][e]=this.outValue[0],s[1][e]=this.outValue[1]}if(Math.abs(l)>Number.MAX_SAFE_INTEGER)return this.resetTime(),!0;this.audioSample+=a;let h=!1;const n={};return l!==this.byteSample&&(h=!0,n.byteSample=this.byteSample=l),r.length&&(h=!0,n.drawBuffer=r),h&&this.sendData(n),!0}receiveData(t){if(void 0!==t.byteSample&&(this.byteSample=+t.byteSample||0,this.resetValues()),!0===t.errorDisplayed&&(this.errorDisplayed=!0),void 0!==t.isPlaying&&(this.isPlaying=t.isPlaying),void 0!==t.playbackSpeed){const e=this.sampleRatio/this.playbackSpeed;this.playbackSpeed=t.playbackSpeed,this.setSampleRatio(e)}if(void 0!==t.mode)switch(this.isFuncbeat="Funcbeat"===t.mode,t.mode){case"Bytebeat":this.getValues=(t,e)=>(this.lastByteValue[e]=255&t)/127.5-1;break;case"Signed Bytebeat":this.getValues=(t,e)=>(this.lastByteValue[e]=t+128&255)/127.5-1;break;case"Floatbeat":case"Funcbeat":this.getValues=(t,e)=>{const s=Math.max(Math.min(t,1),-1);return this.lastByteValue[e]=127.5*s+127.5|0,s};break;case"Bitbeat":this.getValues=(t,e)=>(this.lastByteValue[e]=1&t?255:0,(1&t)-.5);break;case"2048":this.getValues=(t,e)=>(this.lastByteValue[e]=t/8&255,(2047&t)/1023.5-1);break;case"logmode":this.getValues=(t,e)=>(this.lastByteValue[e]=32*Math.log2(t)&255)/127.5-1;break;case"logHack":this.getValues=(t,e)=>{const s=t<0?-32:32;return(this.lastByteValue[e]=Math.log2(Math.abs(t))*s&255)/127.5-1};break;case"logHack2":this.getValues=(t,e)=>{const s=t<0;return 0==t?0:(this.lastByteValue[e]=Math.log2(Math.abs(t))*(s?-16:16)+(s?-127:128)&255)/127.5-1};break;default:this.getValues=t=>NaN}void 0!==t.setFunction&&this.setFunction(t.setFunction),!0===t.resetTime&&this.resetTime(),void 0!==t.sampleRate&&(this.sampleRate=t.sampleRate),void 0!==t.sampleRatio&&this.setSampleRatio(t.sampleRatio),void 0!==t.divisor&&(this.sampleDivisor=t.divisor),void 0!==t.DMode&&(this.soundMode=t.DMode),void 0!==t.drawMode&&(this.drawMode=t.drawMode)}sendData(t){this.port.postMessage(t)}resetTime(){this.byteSample=0,this.resetValues(),this.sendData({byteSample:0})}resetValues(){this.audioSample=0,this.lastTime=-1,this.outValue=[0,0]}setFunction(e){const s={bitC:function(t,e,s){return t&e?s:0},br:function(t,e=8){if(e>32)throw new Error("br() Size cannot be greater than 32");{let a=0;for(let i=0;i<e-0;i++)a+=s.bitC(t,2**i,2**(e-(i+1)));return a}},sinf:function(t){return Math.sin(t/(128/Math.PI))},cosf:function(t){return Math.cos(t/(128/Math.PI))},tanf:function(t){return Math.tan(t/(128/Math.PI))},regG:function(t,e){return e.test(t.toString(2))}},a=Object.getOwnPropertyNames(Math),i=a.map((t=>Math[t])),l=Object.getOwnPropertyNames(s),r=l.map((t=>s[t]));a.push("int","window",...l),i.push(Math.floor,globalThis,...r),t.deleteGlobals();let o=!1;const h=this.func;try{this.isFuncbeat?this.func=new Function(...a,e).bind(globalThis,...i):(e=e.trim().replace(/^eval\(unescape\(escape(?:`|\('|\("|\(`)(.*?)(?:`|'\)|"\)|`\)).replace\(\/u\(\.\.\)\/g,["'`]\$1%["'`]\)\)\)$/,((t,e)=>unescape(escape(e).replace(/u(..)/g,"$1%")))),this.func=new Function(...a,"t",`return 0,\n${e||0};`).bind(globalThis,...i)),o=!0,this.isFuncbeat?(this.func=this.func(),this.func(0,this.sampleRate)):this.func(0)}catch(e){return o||(this.func=h),this.errorDisplayed=!1,void this.sendData({error:{message:t.getErrorMessage(e,o?0:null),isCompiled:o},updateUrl:o})}this.errorDisplayed=!1,this.sendData({error:{message:"",isCompiled:o},updateUrl:!0})}setSampleRatio(t){const e=Math.floor(this.sampleRatio*this.audioSample)-this.lastTime;this.sampleRatio=t*this.playbackSpeed,this.lastTime=Math.floor(this.sampleRatio*this.audioSample)-e}}registerProcessor("audioProcessor",t);
//# sourceMappingURL=audio-processor.mjs.map
